/* graphics.js
   Graphics object handles all rendering.
*/
(function(a){var c,b=a.mapster,d=b.utils;b.Graphics=function(e){var f=this;f.active=false;
f.canvas=null;f.width=0;f.height=0;f.shapes=[];f.masks=[];f.map_data=e;};c=b.Graphics.prototype;
c.begin=function(f,g){var e=a(f);this.elementName=g;this.canvas=f;this.width=e.width();
this.height=e.height();this.shapes=[];this.masks=[];this.active=true;};c.addShape=function(f,g){var e=g.isMask?this.masks:this.shapes;
e.push({mapArea:f,options:g});};c.createVisibleCanvas=function(e){return a(this.createCanvasFor(e)).addClass("mapster_el").css(b.canvas_style)[0];
};c._addShapeGroupImpl=function(e,i,j){var h=this,g=h.map_data,f=j.isMask;a.each(e.areas(),function(l,k){j.isMask=f||(k.nohref&&g.options.noHrefIsMask);
h.addShape(k,j);});j.isMask=f;};c.addShapeGroup=function(e,j,l){var i=this,g,k,f,h=this.map_data,m=e.effectiveRenderOptions(j);
if(l){a.extend(m,l);}if(j==="select"){k="static_"+e.areaId.toString();f=h.base_canvas;
}else{f=h.overlay_canvas;}i.begin(f,k);if(m.includeKeys){g=d.split(m.includeKeys);
a.each(g,function(p,o){var n=h.getDataForKey(o.toString());i._addShapeGroupImpl(n,j,n.effectiveRenderOptions(j));
});}i._addShapeGroupImpl(e,j,m);i.render();if(m.fade){d.fader(b.hasCanvas?f:a(f).find("._fill").not(".mapster_mask"),0,b.hasCanvas?1:m.fillOpacity,m.fadeDuration);
}};b.initGraphics=function(){if(b.hasCanvas){c.hex_to_decimal=function(e){return Math.max(0,Math.min(parseInt(e,16),255));
};c.css3color=function(e,f){return"rgba("+this.hex_to_decimal(e.substr(0,2))+","+this.hex_to_decimal(e.substr(2,2))+","+this.hex_to_decimal(e.substr(4,2))+","+f+")";
};c.renderShape=function(f,h,j){var g,e=h.coords(null,j);switch(h.shape){case"rect":f.rect(e[0],e[1],e[2]-e[0],e[3]-e[1]);
break;case"poly":f.moveTo(e[0],e[1]);for(g=2;g<h.length;g+=2){f.lineTo(e[g],e[g+1]);
}f.lineTo(e[0],e[1]);break;case"circ":case"circle":f.arc(e[0],e[1],e[2],0,Math.PI*2,false);
break;}};c.addAltImage=function(e,f,g,h){e.beginPath();this.renderShape(e,g);e.closePath();
e.clip();e.globalAlpha=h.altImageOpacity||h.fillOpacity;e.drawImage(f,0,0,g.owner.scaleInfo.width,g.owner.scaleInfo.height);
};c.render=function(){var g,h,i=this,f=i.masks.length,j=i.createCanvasFor(i.map_data),k=j.getContext("2d"),e=i.canvas.getContext("2d");
if(f){g=i.createCanvasFor(i.map_data);h=g.getContext("2d");h.clearRect(0,0,g.width,g.height);
a.each(i.masks,function(m,l){h.save();h.beginPath();i.renderShape(h,l.mapArea);h.closePath();
h.clip();h.lineWidth=0;h.fillStyle="#000";h.fill();h.restore();});}a.each(i.shapes,function(l,m){k.save();
if(m.options.fill){if(m.options.alt_image){i.addAltImage(k,m.options.alt_image,m.mapArea,m.options);
}else{k.beginPath();i.renderShape(k,m.mapArea);k.closePath();k.fillStyle=i.css3color(m.options.fillColor,m.options.fillOpacity);
k.fill();}}k.restore();});a.each(i.shapes.concat(i.masks),function(l,n){var m=n.options.strokeWidth===1?0.5:0;
if(n.options.stroke){k.save();k.strokeStyle=i.css3color(n.options.strokeColor,n.options.strokeOpacity);
k.lineWidth=n.options.strokeWidth;k.beginPath();i.renderShape(k,n.mapArea,m);k.closePath();
k.stroke();k.restore();}});if(f){h.globalCompositeOperation="source-out";h.drawImage(j,0,0);
e.drawImage(g,0,0);}else{e.drawImage(j,0,0);}i.active=false;return i.canvas;};c.createCanvasFor=function(e){return a('<canvas width="'+e.scaleInfo.width+'" height="'+e.scaleInfo.height+'"></canvas>')[0];
};c.clearHighlight=function(){var e=this.map_data.overlay_canvas;e.getContext("2d").clearRect(0,0,e.width,e.height);
};c.removeSelections=function(){};c.refreshSelections=function(){var e,f=this.map_data;
e=f.base_canvas;f.base_canvas=this.createVisibleCanvas(f);a(f.base_canvas).hide();
a(e).before(f.base_canvas);f.redrawSelections();a(f.base_canvas).show();a(e).remove();
};}else{d.setOpacity=function(e,f){a(e).each(function(h,g){if(typeof g.opacity!=="undefined"){g.opacity=f;
}else{a(g).css("opacity",f);}});};c.renderShape=function(k,m,g){var l=this,n,h,o,j,i,p,f=k.coords();
j=l.elementName?'name="'+l.elementName+'" ':"";i=g?'class="'+g+'" ':"";o='<v:fill color="#'+m.fillColor+'" class="_fill" opacity="'+(m.fill?m.fillOpacity:0)+'" /><v:stroke class="_fill" opacity="'+m.strokeOpacity+'"/>';
if(m.stroke){n="strokeweight="+m.strokeWidth+' stroked="t" strokecolor="#'+m.strokeColor+'"';
}else{n='stroked="f"';}switch(k.shape){case"rect":p="<v:rect "+i+j+' filled="t" '+n+' style="zoom:1;margin:0;padding:0;display:block;position:absolute;left:'+f[0]+"px;top:"+f[1]+"px;width:"+(f[2]-f[0])+"px;height:"+(f[3]-f[1])+'px;">'+o+"</v:rect>";
break;case"poly":p="<v:shape "+i+j+' filled="t" '+n+' coordorigin="0,0" coordsize="'+l.width+","+l.height+'" path="m '+f[0]+","+f[1]+" l "+f.slice(2).join(",")+' x e" style="zoom:1;margin:0;padding:0;display:block;position:absolute;top:0px;left:0px;width:'+l.width+"px;height:"+l.height+'px;">'+o+"</v:shape>";
break;case"circ":case"circle":p="<v:oval "+i+j+' filled="t" '+n+' style="zoom:1;margin:0;padding:0;display:block;position:absolute;left:'+(f[0]-f[2])+"px;top:"+(f[1]-f[2])+"px;width:"+(f[2]*2)+"px;height:"+(f[2]*2)+'px;">'+o+"</v:oval>";
break;}h=a(p);a(l.canvas).append(h);return h;};c.render=function(){var f,e=this;a.each(this.shapes,function(h,g){e.renderShape(g.mapArea,g.options);
});if(this.masks.length){a.each(this.masks,function(h,g){f=d.updateProps({},g.options,{fillOpacity:1,fillColor:g.options.fillColorMask});
e.renderShape(g.mapArea,f,"mapster_mask");});}this.active=false;return this.canvas;
};c.createCanvasFor=function(f){var g=f.scaleInfo.width,e=f.scaleInfo.height;return a('<var width="'+g+'" height="'+e+'" style="zoom:1;overflow:hidden;display:block;width:'+g+"px;height:"+e+'px;"></var>')[0];
};c.clearHighlight=function(){a(this.map_data.overlay_canvas).children().remove();
};c.removeSelections=function(e){if(e>=0){a(this.map_data.base_canvas).find('[name="static_'+e.toString()+'"]').remove();
}else{a(this.map_data.base_canvas).children().remove();}};c.refreshSelections=function(){return null;
};}};b.initGraphics();}(jQuery));