/* mapdata.js
   the MapData object, repesents an instance of a single bound imagemap
*/
(function(a){var g=a.mapster,l=g.utils;function f(m){a.extend(m,{complete:false,map:null,base_canvas:null,overlay_canvas:null,commands:[],data:[],mapAreas:[],_xref:{},highlightId:-1,currentAreaId:-1,_tooltip_events:[],scaleInfo:null,index:-1,activeAreaEvent:null});
}function e(m){return[m,m.render_highlight,m.render_select];}function d(m){var o=m.options,n=m.images;
if(a.mapster.hasCanvas){a.each(o.altImages||{},function(q,p){n.add(p,q);});a.each([o].concat(o.areas),function(q,p){a.each(e(p),function(s,r){if(r&&r.altImage){r.altImageId=n.add(r.altImage);
}});});}m.area_options=l.updateProps({},g.area_defaults,o);}function k(q,p,m){var o=l.when.defer();
function n(r){if(q.currentAreaId!==r&&q.highlightId>=0){o.resolve();}}if(q.activeAreaEvent){window.clearTimeout(q.activeAreaEvent);
q.activeAreaEvent=0;}if(p<0){return;}if(m.owner.currentAction||p){q.activeAreaEvent=window.setTimeout((function(){return function(){k(0,m,o.resolve);
};}(m)),p||100);}else{n(m.areaId);}return o;}function h(m){if(!a.mapster.hasCanvas){this.blur();
}m.preventDefault();}function j(p,o){var n=p.getAllDataForArea(this),m=n.length?n[0]:null;
if(!m||m.isNotRendered()||m.owner.currentAction){return;}if(p.currentAreaId===m.areaId){return;
}if(p.highlightId!==m.areaId){p.clearEffects();m.highlight();if(p.options.showToolTip){a.each(n,function(r,q){if(q.effectiveOptions().toolTip){q.showToolTip();
}});}}p.currentAreaId=m.areaId;if(a.isFunction(p.options.onMouseover)){p.options.onMouseover.call(this,{e:o,options:m.effectiveOptions(),key:m.key,selected:m.isSelected()});
}}function i(o,n){var p,m=o.getDataForArea(this),q=o.options;if(o.currentAreaId<0||!m){return;
}p=o.getDataForArea(n.relatedTarget);if(p===m){return;}o.currentAreaId=-1;m.area=null;
k(o,q.mouseoutDelay,m).then(o.clearEffects);if(a.isFunction(q.onMouseout)){q.onMouseout.call(this,{e:n,options:q,key:m.key,selected:m.isSelected()});
}}function b(m){var n=m.options;m.ensureNoHighlight();if(n.toolTipClose&&a.inArray("area-mouseout",n.toolTipClose)>=0&&m.activeToolTip){m.clearToolTip();
}}function c(t,q){var w,r,s,u,n,o,x=this,m=t.getDataForArea(this),v=t.options;function p(y){var z,A;
n=(y.isSelectable()&&(y.isDeselectable()||!y.isSelected()));if(n){u=!y.isSelected();
}else{u=y.isSelected();}s=g.getBoundList(v,y.key);if(a.isFunction(v.onClick)){o=v.onClick.call(x,{e:q,listTarget:s,key:y.key,selected:u});
if(l.isBool(o)){if(!o){return false;}A=a(y.area).attr("href");if(A!=="#"){window.location.href=A;
return false;}}}if(n){w=y.toggleSelection();}if(v.boundList&&v.boundList.length>0){g.setBoundListProperties(v,s,y.isSelected());
}z=y.effectiveOptions();if(z.includeKeys){r=l.split(z.includeKeys);a.each(r,function(D,C){var B=t.getDataForKey(C.toString());
if(!B.options.isMask){p(B);}});}}h.call(this,q);if(v.clickNavigate&&m.href){window.location.href=m.href;
return;}if(m&&!m.owner.currentAction){v=t.options;p(m);}}g.MapData=function(m,o){var n=this;
n.image=m;n.images=new g.MapImages(n);n.graphics=new g.Graphics(n);n.imgCssText=m.style.cssText||null;
f(n);n.configureOptions(o);n.mouseover=function(p){j.call(this,n,p);};n.mouseout=function(p){i.call(this,n,p);
};n.click=function(p){c.call(this,n,p);};n.clearEffects=function(p){b.call(this,n,p);
};};g.MapData.prototype={constructor:g.MapData,configureOptions:function(m){this.options=l.updateProps({},g.defaults,m);
},bindImages:function(){var m=this,n=m.images;if(n.length>2){n.splice(2);}else{if(n.length===0){n.add(m.image);
n.add(m.image.src);}}d(m);return m.images.bind();},isActive:function(){return !this.complete||this.currentAction;
},state:function(){return{complete:this.complete,resizing:this.currentAction==="resizing",zoomed:this.zoomed,zoomedArea:this.zoomedArea,scaleInfo:this.scaleInfo};
},wrapId:function(){return"mapster_wrap_"+this.index;},_idFromKey:function(m){return typeof m==="string"&&this._xref.hasOwnProperty(m)?this._xref[m]:-1;
},getSelected:function(){var m="";a.each(this.data,function(o,n){if(n.isSelected()){m+=(m?",":"")+this.key;
}});return m;},getAllDataForArea:function(n,o){var p,m,s,r=this,q=a(n).filter("area").attr(r.options.mapKey);
if(q){s=[];q=l.split(q);for(p=0;p<(o||q.length);p++){m=r.data[r._idFromKey(q[p])];
m.area=n.length?n[0]:n;s.push(m);}}return s;},getDataForArea:function(n){var m=this.getAllDataForArea(n,1);
return m?m[0]||null:null;},getDataForKey:function(m){return this.data[this._idFromKey(m)];
},getKeysForGroup:function(n){var m=this.getDataForKey(n);return !m?"":m.isPrimary?m.key:this.getPrimaryKeysForMapAreas(m.areas()).join(",");
},getPrimaryKeysForMapAreas:function(m){var n=[];a.each(m,function(p,o){if(a.inArray(o.keys[0],n)<0){n.push(o.keys[0]);
}});return n;},getData:function(m){if(typeof m==="string"){return this.getDataForKey(m);
}else{if(m&&m.mapster||l.isElement(m)){return this.getDataForArea(m);}else{return null;
}}},ensureNoHighlight:function(){var m;if(this.highlightId>=0){this.graphics.clearHighlight();
m=this.data[this.highlightId];m.changeState("highlight",false);this.setHighlightId(-1);
}},setHighlightId:function(m){this.highlightId=m;},clearSelections:function(){a.each(this.data,function(n,m){if(m.selected){m.removeSelection(true);
}});this.removeSelectionFinish();},setAreaOptions:function(o){var p,n,m;o=o||[];for(p=o.length-1;
p>=0;p--){n=o[p];if(n){m=this.getDataForKey(n.key);if(m){l.updateProps(m.options,n);
if(l.isBool(n.selected)){m.selected=n.selected;}}}}},drawSelections:function(o){var m,n=l.asArray(o);
for(m=n.length-1;m>=0;m--){this.data[n[m]].drawSelection();}},redrawSelections:function(){a.each(this.data,function(n,m){if(m.isSelectedOrStatic()){m.drawSelection();
}});},initialize:function(){var q,m,t,z,u,n,o,w,p,x,y,v,r=this,s=r.options;if(r.complete){return;
}p=a(r.image);u=p.parent().attr("id");if(u&&u.length>=12&&u.substring(0,12)==="mapster_wrap"){z=p.parent();
z.attr("id",r.wrapId());}else{z=a('<div id="'+r.wrapId()+'"></div>');if(s.wrapClass){if(s.wrapClass===true){z.addClass(p[0].className);
}else{z.addClass(s.wrapClass);}}}r.wrapper=z;r.scaleInfo=v=l.scaleMap(r.images[0],r.images[1],s.scaleMap);
r.base_canvas=m=r.graphics.createVisibleCanvas(r);r.overlay_canvas=t=r.graphics.createVisibleCanvas(r);
q=a(r.images[1]).addClass("mapster_el "+r.images[0].className).attr({id:null,usemap:null});
w=l.size(r.images[0]);if(w.complete){q.css({width:w.width,height:w.height});}r.buildDataset();
n={display:"block",position:"relative",padding:0,width:v.width,height:v.height};if(s.wrapCss){a.extend(n,s.wrapCss);
}if(p.parent()[0]!==r.wrapper[0]){p.before(r.wrapper);}z.css(n);a(r.images.slice(2)).hide();
for(o=1;o<r.images.length;o++){z.append(r.images[o]);}z.append(m).append(t).append(p.css(g.canvas_style));
l.setOpacity(r.images[0],0);a(r.images[1]).show();l.setOpacity(r.images[1],1);if(s.isSelectable&&s.onGetList){y=r.data.slice(0);
if(s.sortList){if(s.sortList==="desc"){x=function(A,B){return A===B?0:(A>B?-1:1);
};}else{x=function(A,B){return A===B?0:(A<B?-1:1);};}y.sort(function(A,B){A=A.value;
B=B.value;return x(A,B);});}r.options.boundList=s.onGetList.call(r.image,y);}r.complete=true;
r.processCommandQueue();if(s.onConfigured&&typeof s.onConfigured==="function"){s.onConfigured.call(p,true);
}},buildDataset:function(D){var E,q,w,p,m,o,r,z,x,y,A,u,s,v,B=this,C=B.options,t;
function n(G,H){var F=new g.AreaData(B,G,H);F.areaId=B._xref[G]=B.data.push(F)-1;
return F.areaId;}B._xref={};B.data=[];if(!D){B.mapAreas=[];}t=!C.mapKey;if(t){C.mapKey="data-mapster-key";
}E=(a.browser.msie&&a.browser.version<=7)?"area":(t?"area[coords]":"area["+C.mapKey+"]");
q=a(B.map).find(E).unbind(".mapster");for(A=0;A<q.length;A++){p=0;o=q[A];m=a(o);if(!o.coords){continue;
}if(t){r=String(A);m.attr("data-mapster-key",r);}else{r=o.getAttribute(C.mapKey);
}if(D){z=B.mapAreas[m.data("mapster")-1];z.configure(r);}else{z=new g.MapArea(B,o,r);
B.mapAreas.push(z);}y=z.keys;for(w=y.length-1;w>=0;w--){x=y[w];if(C.mapValue){u=m.attr(C.mapValue);
}if(t){p=n(B.data.length,u);s=B.data[p];s.key=x=p.toString();}else{p=B._xref[x];if(p>=0){s=B.data[p];
if(u&&!B.data[p].value){s.value=u;}}else{p=n(x,u);s=B.data[p];s.isPrimary=w===0;}}z.areaDataXref.push(p);
s.areasXref.push(A);}v=m.attr("href");if(v&&v!=="#"&&!s.href){s.href=v;}if(!z.nohref){m.bind("mouseover.mapster",B.mouseover).bind("mouseout.mapster",B.mouseout).bind("click.mapster",B.click).bind("mousedown.mapster",B.mousedown);
}m.data("mapster",A+1);}B.setAreaOptions(C.areas);B.redrawSelections();},processCommandQueue:function(){var m,n=this;
while(!n.currentAction&&n.commands.length){m=n.commands[0];n.commands.splice(0,1);
g.impl[m.command].apply(m.that,m.args);}},clearEvents:function(){a(this.map).find("area").unbind(".mapster");
a(this.images).unbind(".mapster");},_clearCanvases:function(m){if(!m){a(this.base_canvas).remove();
}a(this.overlay_canvas).remove();},clearMapData:function(n){var m=this;this._clearCanvases(n);
a.each(this.data,function(p,o){o.reset();});this.data=null;if(!n){this.image.style.cssText=this.imgCssText;
a(this.wrapper).before(this.image).remove();}m.images.clear();this.image=null;l.ifFunction(this.clearTooltip,this);
},removeSelectionFinish:function(){var m=this.graphics;m.refreshSelections();m.clearHighlight();
}};}(jQuery));