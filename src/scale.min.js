/* scale.js: resize and zoom functionality
   requires areacorners.js
*/
(function(a){var b=a.mapster,d=b.utils,c=b.MapArea.prototype;b.utils.getScaleInfo=function(f,e){var g;
if(!e){g=1;e=f;}else{g=f.width/e.width||f.height/e.height;if(g>0.98&&g<1.02){g=1;
}}return{scale:(g!==1),scalePct:g,realWidth:e.width,realHeight:e.height,width:f.width,height:f.height,ratio:f.width/f.height};
};b.utils.scaleMap=function(e,f,h){var i=d.size(e),g=d.size(f);if(!g.complete){throw ("Another script, such as an extension, appears to be interfering with image loading. Please let us know about this.");
}if(!i.complete){i=g;}return this.getScaleInfo(i,h?g:null);};b.MapData.prototype.resize=function(o,m,g,e){var k,q,t,j,f,p={callback:e||g},n,h,l=this;
function s(u,x,v){if(a.mapster.hasCanvas){u.width=x;u.height=v;}else{a(u).width(x);
a(u).height(v);}}function i(){s(l.overlay_canvas,t,j);if(p.highlight&&k>=0){var u=l.data[k];
u.tempOptions={fade:false};l.getDataForKey(u.key).highlight();u.tempOptions=null;
}s(l.base_canvas,t,j);l.redrawSelections();l.currentAction="";if(a.isFunction(p.callback)){p.callback();
}l.processCommandQueue();}function r(){a(l.image).css(n);l.scaleInfo=d.getScaleInfo({width:t,height:j},{width:l.scaleInfo.realWidth,height:l.scaleInfo.realHeight});
a.each(l.data,function(v,u){a.each(u.areas(),function(x,w){w.resize();});});}if(typeof o==="object"){p=o;
}else{p.width=o;p.height=m;p.duration=g||0;}t=p.width;j=p.height;f=p.duration;if(l.scaleInfo.width===t&&l.scaleInfo.height===j){return;
}k=l.highlightId;if(!t){q=j/l.scaleInfo.realHeight;t=Math.round(l.scaleInfo.realWidth*q);
}if(!j){q=t/l.scaleInfo.realWidth;j=Math.round(l.scaleInfo.realHeight*q);}n={width:String(t)+"px",height:String(j)+"px"};
if(!a.mapster.hasCanvas){a(l.base_canvas).children().remove();}h=a(l.wrapper).find(".mapster_el").add(l.wrapper);
if(f){l.currentAction="resizing";h.each(function(v,u){a(u).animate(n,{duration:f,complete:v===0?i:null,easing:"linear"});
});a(l.wrapper).animate({scrollLeft:p.scrollLeft||0,scrollTop:p.scrollTop||0},{duration:f,easing:"linear"});
r();}else{h.css(n);i();r();}};b.MapArea=d.subclass(b.MapArea,function(){this.base.init();
if(this.owner.scaleInfo.scale){this.resize();}});c.coords=function(k,e){var f,g=[],i=k||this.owner.scaleInfo.scalePct,h=e||0;
if(i===1&&e===0){return this.originalCoords;}for(f=0;f<this.length;f++){g.push(Math.round(this.originalCoords[f]*i)+h);
}return g;};c.resize=function(){this.area.coords=this.coords().join(",");};c.reset=function(){this.area.coords=this.coords(1).join(",");
};b.impl.resize=function(g,f,e){if(!g&&!f){return false;}var h=(new b.Method(this,function(){this.resize(g,f,e);
},null,{name:"resize",args:arguments})).go();return h;};b.impl.zoom=function(e,g){var f=g||{};
function h(i){var w,j,m,A,t,k,l,u,v,q,r,p,o,y,z,s=f.padding||0,x=i?20:0,n=this,B=false;
if(i){if(!n.zoomed){n.zoomed=true;n.preZoomWidth=n.scaleInfo.width;n.preZoomHeight=n.scaleInfo.height;
n.zoomedArea=i;if(f.scroll){n.wrapper.css({overflow:"auto"});}}j=a.mapster.utils.areaCorners(i.coords(1,0));
A=n.wrapper.innerWidth()-x-s*2;m=n.wrapper.innerHeight()-x-s*2;k=j.maxX-j.minX;l=j.maxY-j.minY;
u=A/k;v=m/l;t=Math.min(u,v);q=(A-k*t)/2;r=(m-l*t)/2;p=n.scaleInfo.realWidth*t;o=n.scaleInfo.realHeight*t;
y=(j.minX)*t-s-q;z=(j.minY)*t-s-r;}else{if(!n.zoomed){return;}B=true;p=n.preZoomWidth;
o=n.preZoomHeight;y=null;z=null;}this.resize({width:p,height:o,duration:f.duration,scroll:w,scrollLeft:y,scrollTop:z,callback:(function(){var D=B,E=f.scroll,C=i;
return function(){if(D){n.preZoomWidth=null;n.preZoomHeight=null;n.zoomed=false;n.zoomedArea=false;
if(E){n.wrapper.css({overflow:"inherit"});}}else{n.zoomedArea=C;}};}())});}return(new b.Method(this,function(i){h.call(this);
},function(){h.call(this.owner,this);},{name:"zoom",args:arguments,first:true,key:e})).go();
};}(jQuery));